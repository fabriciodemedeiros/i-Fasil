<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Secretarias</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="text-uppercase" style="font-family: 'Lucida Console', monospace; color: #003366;">Secretarias</h2>
        <button id="logoutBtn" class="btn btn-danger">Sair</button>
    </div>

    <table id="secretariasTable" class="table table-bordered table-striped" style="width:100%">
        <thead>
            <tr>
                <th>ID</th>
                <th>Secretaria</th>
                <th>Sigla</th>
                <th>Descrição</th>
                <th>Email</th>
                <th>Telefone</th>
                <th>Cidade / UF</th>
                <th>Criado em</th>
                <th>Atualizado em</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="9" class="text-center">Carregando...</td></tr>
        </tbody>
    </table>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
const API_SECRETARIAS = "https://www.fasil.criarsite.online/api/v1/secretarias";

// Verifica login
const token = localStorage.getItem("jwt_token");
if (!token) window.location.href = "login.html";

// Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.clear();
    window.location.href = "login.html";
});

// Carrega secretarias
async function carregarSecretarias() {
    try {
        const resp = await fetch(API_SECRETARIAS, {
            headers: {
                "Authorization": `Bearer ${token}`
            }
        });

        if (!resp.ok) throw new Error("Não autorizado ou erro na API");

        const secretarias = await resp.json();
        const tbody = document.querySelector("#secretariasTable tbody");
        tbody.innerHTML = "";

        secretarias.forEach(sec => {
            const criado = sec.created_at ? new Date(sec.created_at).toLocaleString('pt-BR') : '--';
            const atualizado = sec.updated_at ? new Date(sec.updated_at).toLocaleString('pt-BR') : '--';

            tbody.innerHTML += `
                <tr>
                    <td>${sec.id_secretaria ?? '--'}</td>
                    <td>${sec.secretaria ?? '--'}</td>
                    <td>${sec.sigla ?? '--'}</td>
                    <td>${sec.descricao ?? '--'}</td>
                    <td>${sec.email ?? '--'}</td>
                    <td>${sec.telefone ?? '--'}</td>
                    <td>${sec.cidade ?? '--'} / ${sec.uf ?? '--'}</td>
                    <td>${criado}</td>
                    <td>${atualizado}</td>
                </tr>
            `;
        });

        $('#secretariasTable').DataTable({
            pageLength: 10,
            language: {
                url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json"
            }
        });

    } catch (err) {
        console.error(err);
        alert("Erro ao carregar secretarias. Faça login novamente.");
        localStorage.clear();
        window.location.href = "login.html";
    }
}

document.addEventListener("DOMContentLoaded", carregarSecretarias);
</script>
</body>
</html>
