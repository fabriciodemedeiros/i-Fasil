<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Editar Departamento</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
	<div class="container mt-3">
	
	<div class="card shadow rounded-4">
		<div class="card-header bg-warning text-dark rounded-top-4">
			<h4 class="mb-0">Editar Departamento</h4>
		</div>

		<form action="/api/servidores/update.php?id=<?= $servidor['id_servidor'] ?>" method="POST" class="container mt-5">
			<h2 class="mb-4">Editar Servidor</h2>
			<div class="mb-3">
			  <label class="form-label">Nome Completo</label>
			  <input type="text" class="form-control" name="servidor" value="<?= htmlspecialchars($servidor['servidor']) ?>" required>
			</div>
			<div class="row">
			  <div class="col-md-6 mb-3">
				<label class="form-label">CPF</label>
				<input type="text" class="form-control" name="cpf" value="<?= $servidor['cpf'] ?>" required>
			  </div>
			  <div class="col-md-6 mb-3">
				<label class="form-label">Matrícula</label>
				<input type="text" class="form-control" name="matricula" value="<?= $servidor['matricula'] ?>" required>
			  </div>
			</div>
			<div class="row">
			  <div class="col-md-6 mb-3">
				<label class="form-label">Data de Nascimento</label>
				<input type="date" class="form-control" name="data_nascimento" value="<?= $servidor['data_nascimento'] ?>">
			  </div>
			  <div class="col-md-6 mb-3">
				<label class="form-label">Data de Admissão</label>
				<input type="date" class="form-control" name="data_admissao" value="<?= $servidor['data_admissao'] ?>">
			  </div>
			</div>
			<div class="mb-3">
			  <label class="form-label">E-mail</label>
			  <input type="email" class="form-control" name="email" value="<?= $servidor['email'] ?>">
			</div>
			<div class="mb-3">
			  <label class="form-label">Telefone</label>
			  <input type="text" class="form-control" name="telefone" value="<?= $servidor['telefone'] ?>">
			</div>
			<fieldset class="border p-3 mb-3">
			  <legend class="float-none w-auto px-2">Endereço</legend>
			  <div class="row mb-3">
				<div class="col-md-8">
				  <label class="form-label">Logradouro</label>
				  <input type="text" class="form-control" name="endereco" value="<?= $servidor['endereco'] ?>">
				</div>
				<div class="col-md-4">
				  <label class="form-label">Número</label>
				  <input type="text" class="form-control" name="numero" value="<?= $servidor['numero'] ?>">
				</div>
			  </div>
			  <div class="row mb-3">
				<div class="col-md-4">
				  <label class="form-label">Bairro</label>
				  <input type="text" class="form-control" name="bairro" value="<?= $servidor['bairro'] ?>">
				</div>
				<div class="col-md-4">
				  <label class="form-label">Cidade</label>
				  <input type="text" class="form-control" name="cidade" value="<?= $servidor['cidade'] ?>">
				</div>
				<div class="col-md-2">
				  <label class="form-label">UF</label>
				  <input type="text" class="form-control" name="uf" maxlength="2" value="<?= $servidor['uf'] ?>">
				</div>
				<div class="col-md-2">
				  <label class="form-label">CEP</label>
				  <input type="text" class="form-control" name="cep" maxlength="8" value="<?= $servidor['cep'] ?>">
				</div>
			  </div>
			</fieldset>
			<div class="mb-3">
			  <label class="form-label">IP de Cadastro</label>
			  <input type="text" class="form-control" name="ip_at" value="<?= $servidor['ip_at'] ?>" required>
			</div>
			<button type="submit" class="btn btn-success">Salvar Alterações</button>
		  </form>
		  
	</div>
  </div>

  <script src="js/api.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    fetchDepartamentos().then(departamentos => {
      const departamento = departamentos.find(d => d.id == id);
      if (departamento) {
        document.getElementById("id").value = departamento.id;
        document.getElementById("id_secretaria").value = departamento.id_secretaria;
        document.getElementById("id_prefeitura").value = departamento.id_prefeitura;
        document.getElementById("departamento").value = departamento.departamento;
        document.getElementById("sigla").value = departamento.sigla;
        document.getElementById("descricao").value = departamento.descricao;
        document.getElementById("email").value = departamento.email;
        document.getElementById("telefone").value = departamento.telefone;
        document.getElementById("endereco").value = departamento.endereco;
        document.getElementById("numero").value = departamento.numero;
        document.getElementById("bairro").value = departamento.bairro;
        document.getElementById("cidade").value = departamento.cidade;
        document.getElementById("uf").value = departamento.uf;
        document.getElementById("cep").value = departamento.cep;
		document.getElementById("ip_at").textContent = departamento.ip_at;
      } else {
        alert("Departamento não encontrado.");
      }
    });

    document.getElementById("form-edit").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        id: parseInt(document.getElementById("id").value),
        id_secretaria: parseInt(document.getElementById("id_secretaria").value),
        id_prefeitura: parseInt(document.getElementById("id_prefeitura").value),
        departamento: document.getElementById("departamento").value.trim(),
        sigla: document.getElementById("sigla").value.trim(),
        descricao: document.getElementById("descricao").value.trim(),
        email: document.getElementById("email").value.trim(),
        telefone: document.getElementById("telefone").value.trim(),
        endereco: document.getElementById("endereco").value.trim(),
        numero: document.getElementById("numero").value.trim(),
        bairro: document.getElementById("bairro").value.trim(),
        cidade: document.getElementById("cidade").value.trim(),
        uf: document.getElementById("uf").value,
        cep: document.getElementById("cep").value.trim(),
      };

      const sucesso = await atualizarDepartamento(data);
      if (sucesso) {
        alert("Departamento atualizado com sucesso!");
        window.location.href = "departamentos.html";
      } else {
        alert("Erro ao atualizar o departamento.");
      }
    });
  </script>
</body>
</html>
